{
  "id": "ecommerce_item_recs",
  "stages": [
    {
      "type": "set-params",
      "id": "8ptvmh35qp24t2o6r",
      "params": [
        {
          "key": "id",
          "value": "2842056",
          "policy": "append"
        }
      ],
      "skip": true,
      "label": "set-params"
    },
    {
      "type": "javascript-query",
      "id": "9vnc8pjnroyshsemi",
      "script": "var itemId = request.getFirstParam('id');\nif (itemId != '*:*' && itemId != '*') {\n  request.putSingleParam('itemId',itemId);\n} ",
      "skip": false,
      "label": "Item Recs: Prepare sub-query"
    },
    {
      "type": "sub-query",
      "id": "ph7c4dbjicynqxgvi",
      "key": "rec-collection-results",
      "collection": "ecommerce_signals_item_sims",
      "handler": "select",
      "method": "GET",
      "parentParams": [
        "itemId",
        "id"
      ],
      "rollupKeys": [

      ],
      "params": [
        {
          "key": "rows",
          "value": "10"
        },
        {
          "key": "sort",
          "value": "sim desc"
        },
        {
          "key": "q",
          "value": "*:*"
        },
        {
          "key": "fq",
          "value": "({!field f=itemId v=$itemId} AND -{!field f=otherItemId v=$itemId})"
        }
      ],
      "headers": [

      ],
      "skip": false,
      "label": "Item Recs: Retrieve"
    },
    {
      "type": "javascript-query",
      "id": "wm6t86a5dval15rk9",
      "script": "var recs_data = ctx.getProperty('rec-collection-results');\nvar orig_q = request.getFirstParam('q');\nvar boost_list = \"\"\n\nfor(var recs_index=0; recs_index < recs_data.response.docs.size(); recs_index++) {\n  \trequest.putSingleParam('recs','on');\n\tvar rec = recs_data.response.docs[recs_index];\n\n\tboost_list += \"id\" + ':' + rec.otherItemId + '^=' + 100*(recs_data.response.docs.size() - recs_index) + ' ';\n}\nrequest.putSingleParam('orig_q',orig_q);\nrequest.putSingleParam('orig_score','query({!edismax v=$orig_q})');\nrequest.putSingleParam('orig_scaled','scale($orig_score,1,99)');\nrequest.putSingleParam('boost_list',boost_list);\nrequest.putSingleParam('q','({!lucene v=$boost_list}) (-({!lucene v=$boost_list}) {!frange l=1 v=$orig_scaled})');\n",
      "skip": false,
      "label": "Item Recs: Process",
      "condition": ""
    },
    {
      "type": "solr-query",
      "id": "s52xjgnc6kio4j9k9",
      "allowedRequestHandlers": [

      ],
      "httpMethod": "POST",
      "allowFederatedSearch": false,
      "skip": false,
      "label": "solr-query",
      "condition": "request.getFirstParam('recs') == 'on'"
    }
  ],
  "properties": {

  }
}